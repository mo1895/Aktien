<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Portfolio Übersicht</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            margin: 0;
            padding: 30px;
            font-family: Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
            font-weight: 600;
        }

        .button {
            display: block;
            margin: 0 auto 30px;
            padding: 12px 22px;
            background: #2867B2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
        }

        .button:hover {
            background: #1d4c86;
        }

        .summary-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 800px;
            margin: 0 auto 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stock {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 0 auto 30px;
            max-width: 800px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stock h2 {
            margin-top: 0;
        }

        .change-up { color: #2ecc71; }
        .change-down { color: #e74c3c; }
        .change-neutral { color: #555; }

        .rating {
            margin-top: 10px;
            color: #f39c12;
        }

        a {
            color: #2867B2;
            text-decoration: none;
        }
        a:hover { text-decoration: underline; }

        #last-update {
            text-align: center;
            margin-top: 20px;
            color: #777;
            font-size: 14px;
        }
    </style>
</head>

<body>

<h1>Mein Aktien-Portfolio</h1>

<button id="refresh-btn" class="button">Aktualisieren</button>

<div class="summary-box">
    <h2>Portfolio Übersicht</h2>
    <div id="total-value">Wird berechnet...</div>
    <div id="portfolio-change" class="change-neutral"></div>
</div>

<div id="stocks">Lade Daten…</div>

<div id="last-update"></div>

<script>
/* ------------------ KONFIG ------------------ */

const stocks = [
    { name: "Lufthansa", symbol: "LHA.DE", shares: 5, link: "https://www.finanzen.net/aktien/lufthansa-aktie", rating: { score: 3.5, comment: "Unterbewertet. Gute Aussichten." } },
    { name: "DroneShield", symbol: "DRO.AX", shares: 30, link: "https://www.finanzen.net/aktien/droneshield-aktie", rating: { score: 4.5, comment: "Starker Wachstumswert." } },
    { name: "BYD", symbol: "1211.HK", shares: 4, link: "https://www.finanzen.net/aktien/byd-aktie", rating: { score: 4.0, comment: "EV-Leader. Buy." } },
    { name: "Intel", symbol: "INTC", shares: 2, link: "https://www.finanzen.net/aktien/intel-aktie", rating: { score: 2.5, comment: "Risiko, aber Potential." } },
    { name: "Siemens Energy", symbol: "ENR.DE", shares: 2, link: "https://www.finanzen.net/aktien/siemens_energy-aktie", rating: { score: 3.8, comment: "Turnaround möglich." } },
    { name: "Clara Tech", symbol: "CLA.DE", shares: 10, link: "#", fixedPrice: 3.5, rating: { score: 2.0, comment: "Spekulativ." } }
];

const exchangeRates = { AUD: 0.60, HKD: 0.12, USD: 0.92 };
let portfolio = { total: 0, last: 0 };

/* ------------------ DATENHOLEN ------------------ */

async function fetchStock(symbol) {
    if (symbol === "CLA.DE") {
        return {
            timestamp: [1,2,3,4,5],
            indicators: { quote: [{ close: [3.5,3.5,3.5,3.5,3.5] }] },
            meta: { regularMarketPrice: 3.5 }
        };
    }

    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=5d&interval=1d`;

    const proxied = `https://corsproxy.io/?${encodeURIComponent(url)}`;

    let res = await fetch(proxied);
    let json = await res.json();

    return json.chart.result[0];
}

function convert(price, symbol) {
    if (symbol.endsWith(".DE")) return price;
    if (symbol.endsWith(".AX")) return price * exchangeRates.AUD;
    if (symbol.endsWith(".HK")) return price * exchangeRates.HKD;
    return price * exchangeRates.USD;
}

/* ------------------ UI ------------------ */

function starRating(score) {
    let full = Math.floor(score);
    let half = score % 1 !== 0;
    let out = "";

    for (let i = 0; i < 5; i++) {
        if (i < full) out += '<i class="fas fa-star"></i>';
        else if (i === full && half) out += '<i class="fas fa-star-half-alt"></i>';
        else out += '<i class="far fa-star"></i>';
    }
    return out;
}

async function loadStocks() {
    const container = document.getElementById("stocks");
    container.innerHTML = "";

    portfolio.last = portfolio.total;
    portfolio.total = 0;

    for (const s of stocks) {
        let box = document.createElement("div");
        box.className = "stock";
        box.innerHTML = `<h2>${s.name}</h2>Lade…`;
        container.appendChild(box);

        try {
            const data = await fetchStock(s.symbol);

            const prices = data.indicators.quote[0].close;
            const latest = convert(data.meta.regularMarketPrice, s.symbol);
            const previous = convert(prices[prices.length-2], s.symbol);
            const diff = latest - previous;

            const value = latest * s.shares;
            portfolio.total += value;

            box.innerHTML = `
                <h2>${s.name} (${s.symbol})</h2>
                
                <p>Preis: <strong>${latest.toFixed(2)} €</strong>
                <span class="${diff>0?'change-up':diff<0?'change-down':'change-neutral'}">
                    (${diff>=0?'+':''}${diff.toFixed(2)} €)
                </span></p>

                <p>Anteile: ${s.shares} – Gesamtwert: <strong>${value.toFixed(2)} €</strong></p>

                <div class="rating">
                    ${starRating(s.rating.score)} (${s.rating.score}/5)
                </div>
                <small>${s.rating.comment}</small><br><br>

                <a href="${s.link}" target="_blank">Details ansehen</a>
            `;
        } catch (e) {
            box.innerHTML = `<h2>${s.name}</h2>Fehler beim Laden`;
        }
    }

    updateSummary();
}

function updateSummary() {
    document.getElementById("total-value").textContent =
        "Gesamtwert: " + portfolio.total.toFixed(2) + " €";

    const diff = portfolio.total - portfolio.last;
    const el = document.getElementById("portfolio-change");

    if (portfolio.last > 0) {
        el.className = diff > 0 ? "change-up" : diff < 0 ? "change-down" : "change-neutral";
        el.textContent = (diff >= 0 ? "+" : "") + diff.toFixed(2) + " €";
    }

    document.getElementById("last-update").textContent =
        "Zuletzt aktualisiert: " + new Date().toLocaleTimeString();
}

document.getElementById("refresh-btn").onclick = loadStocks;

loadStocks();
</script>

</body>
</html>
