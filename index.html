<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live MarktÃ¼bersicht</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f0f2f5;
      color: #1a1a2e;
      padding: 80px 20px 40px;
    }

    /* â”€â”€ Top Bar â”€â”€ */
    .topbar {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 60px;
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      z-index: 999;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .topbar h1 {
      font-size: 18px;
      font-weight: 700;
      color: #1a1a2e;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    #last-update {
      font-size: 12px;
      color: #888;
    }

    #refresh-btn {
      padding: 8px 18px;
      background: #0055cc;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    #refresh-btn:hover { background: #0044aa; }
    #refresh-btn:disabled { background: #aaa; cursor: default; }

    /* â”€â”€ Layout â”€â”€ */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* â”€â”€ Card â”€â”€ */
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.07);
      border: 1px solid #e8e8e8;
      transition: box-shadow 0.2s;
    }

    .card:hover {
      box-shadow: 0 6px 24px rgba(0,0,0,0.12);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      color: #1a1a2e;
    }

    .card-symbol {
      font-size: 12px;
      color: #888;
      margin-top: 2px;
    }

    .card-badge {
      font-size: 11px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 20px;
      background: #f0f2f5;
      color: #555;
    }

    .price-row {
      display: flex;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 6px;
    }

    .price-main {
      font-size: 26px;
      font-weight: 800;
      color: #1a1a2e;
    }

    .price-change {
      font-size: 13px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
    }

    .change-up   { color: #16a34a; background: #dcfce7; }
    .change-down { color: #dc2626; background: #fee2e2; }
    .change-neutral { color: #555;  background: #f0f0f0; }

    .card-link {
      font-size: 12px;
      color: #0055cc;
      text-decoration: none;
      display: inline-block;
      margin-bottom: 14px;
    }

    .card-link:hover { text-decoration: underline; }

    .card-error {
      color: #dc2626;
      font-size: 13px;
      padding: 10px 0;
    }

    canvas { width: 100% !important; }

    /* â”€â”€ Skeleton Loader â”€â”€ */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.4s infinite;
      border-radius: 6px;
      height: 18px;
      margin-bottom: 10px;
    }

    @keyframes shimmer {
      0%   { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* â”€â”€ Status Banner â”€â”€ */
    #status-banner {
      text-align: center;
      font-size: 13px;
      color: #888;
      margin-bottom: 16px;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>
<body>

  <!-- Top Bar -->
  <div class="topbar">
    <h1>ğŸ“ˆ Live MarktÃ¼bersicht</h1>
    <div class="topbar-right">
      <span id="last-update"></span>
      <button id="refresh-btn">ğŸ”„ Aktualisieren</button>
    </div>
  </div>

  <div id="status-banner"></div>

  <!-- Grid -->
  <div class="grid" id="grid"></div>

  <script>
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     KONFIGURATION
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const STOCKS = [
    { name: "Clara Technologies", symbol: "CLTE.CA", currency: "CAD", link: "https://www.finanzen.net/aktien/clara_technologies-aktie" },
    { name: "Lufthansa",          symbol: "LHA.DE",  currency: "EUR", link: "https://www.finanzen.net/aktien/lufthansa-aktie" },
    { name: "DroneShield",        symbol: "DRO.AX",  currency: "AUD", link: "https://www.finanzen.net/aktien/droneshield-aktie" },
    { name: "BYD",                symbol: "1211.HK", currency: "HKD", link: "https://www.finanzen.net/aktien/byd-aktie" },
    { name: "Intel",              symbol: "INTC",    currency: "USD", link: "https://www.finanzen.net/aktien/intel-aktie" },
    { name: "Siemens Energy",     symbol: "ENR.DE",  currency: "EUR", link: "https://www.finanzen.net/aktien/siemens_energy-aktie" },
    { name: "Gold (10g)",         symbol: "GC=F",    currency: "USD", isGold: true, link: "https://www.finanzen.net/rohstoffe/goldpreis" }
  ];

  /* Feste Fallback-Kurse falls FX-API versagt */
  const FX_FALLBACK = { EUR: 1, USD: 0.92, AUD: 0.60, HKD: 0.12, CAD: 0.68 };

  /* CORS-Proxies */
  const PROXIES = [
    u => `https://corsproxy.io/?${encodeURIComponent(u)}`,
    u => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`
  ];

  /* Gespeicherte Charts */
  const charts = {};
  let fxRates = { ...FX_FALLBACK };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FETCH HELPER mit Proxy-Fallback
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function fetchJSON(apiUrl) {
    for (const proxy of PROXIES) {
      try {
        const res = await fetch(proxy(apiUrl), { cache: "no-cache" });
        if (!res.ok) continue;
        let json = await res.json();
        if (json.contents) json = JSON.parse(json.contents);
        return json;
      } catch (_) { /* nÃ¤chsten Proxy probieren */ }
    }
    throw new Error("Alle Proxies fehlgeschlagen");
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     WECHSELKURSE laden
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function loadFxRates() {
    const currencies = [...new Set(STOCKS.map(s => s.currency))].filter(c => c !== "EUR");
    await Promise.all(currencies.map(async cur => {
      try {
        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${cur}EUR=X?range=1d&interval=1d`;
        const json = await fetchJSON(url);
        const rate = json.chart?.result?.[0]?.meta?.regularMarketPrice;
        if (rate) fxRates[cur] = rate;
      } catch (_) { /* Fallback bleibt */ }
    }));
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     KURS-DATEN laden
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function fetchChartData(symbol) {
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=5d&interval=1d`;
    const json = await fetchJSON(url);
    const result = json.chart?.result?.[0];
    if (!result) throw new Error("Keine Daten");
    return result;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CHART erstellen / updaten
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function renderChart(canvasId, labels, prices, isUp) {
    const color = isUp ? "#16a34a" : "#dc2626";
    const bgColor = isUp ? "rgba(22,163,74,0.08)" : "rgba(220,38,38,0.08)";

    if (charts[canvasId]) {
      const c = charts[canvasId];
      c.data.labels = labels;
      c.data.datasets[0].data = prices;
      c.data.datasets[0].borderColor = color;
      c.data.datasets[0].backgroundColor = bgColor;
      c.update();
      return;
    }

    const ctx = document.getElementById(canvasId)?.getContext("2d");
    if (!ctx) return;

    charts[canvasId] = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          data: prices,
          borderColor: color,
          backgroundColor: bgColor,
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointRadius: 3,
          pointHoverRadius: 5
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false }, tooltip: { mode: "index", intersect: false } },
        scales: {
          x: { grid: { display: false }, ticks: { font: { size: 10 } } },
          y: { grid: { color: "#f0f0f0" }, ticks: { font: { size: 10 }, callback: v => v.toFixed(2) + " â‚¬" } }
        }
      }
    });
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     KARTE bauen
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function getOrCreateCard(id) {
    let card = document.getElementById(id);
    if (!card) {
      card = document.createElement("div");
      card.className = "card";
      card.id = id;
      document.getElementById("grid").appendChild(card);
    }
    return card;
  }

  function skeletonCard(name, symbol) {
    const card = getOrCreateCard("card-" + symbol.replace(/[^a-z0-9]/gi, "_"));
    card.innerHTML = `
      <div class="card-header">
        <div>
          <div class="card-title">${name}</div>
          <div class="card-symbol">${symbol}</div>
        </div>
      </div>
      <div class="skeleton" style="width:60%; height:28px;"></div>
      <div class="skeleton" style="width:40%;"></div>
      <div class="skeleton" style="width:30%;"></div>
      <div class="skeleton" style="height:120px; margin-top:10px;"></div>
    `;
  }

  function fillCard(stock, pricesEUR, labels, latest, prev) {
    const diff    = latest - prev;
    const pct     = prev > 0 ? (diff / prev) * 100 : 0;
    const isUp    = diff >= 0;
    const cls     = diff > 0 ? "change-up" : diff < 0 ? "change-down" : "change-neutral";
    const sign    = diff >= 0 ? "+" : "";
    const symbol  = stock.symbol;
    const safeId  = symbol.replace(/[^a-z0-9]/gi, "_");
    const cardId  = "card-" + safeId;
    const chartId = "chart-" + safeId;

    /* Preis-Label fÃ¼r Gold anpassen */
    const displayPrice = stock.isGold
      ? (latest / 31.1034768 * 10).toFixed(2) + " â‚¬  (10g)"
      : latest.toFixed(2) + " â‚¬";

    const card = getOrCreateCard(cardId);
    card.innerHTML = `
      <div class="card-header">
        <div>
          <div class="card-title">${stock.name}</div>
          <div class="card-symbol">${symbol}</div>
        </div>
        <span class="card-badge">${stock.currency}</span>
      </div>

      <div class="price-row">
        <span class="price-main">${displayPrice}</span>
        <span class="price-change ${cls}">${sign}${diff.toFixed(2)} â‚¬ Â· ${sign}${pct.toFixed(2)}%</span>
      </div>

      <a class="card-link" href="${stock.link}" target="_blank">Details auf Finanzen.net â†’</a>

      <canvas id="${chartId}" height="140"></canvas>
    `;

    renderChart(chartId, labels, pricesEUR, isUp);
  }

  function errorCard(stock, message) {
    const safeId = stock.symbol.replace(/[^a-z0-9]/gi, "_");
    const card = getOrCreateCard("card-" + safeId);
    card.innerHTML = `
      <div class="card-header">
        <div>
          <div class="card-title">${stock.name}</div>
          <div class="card-symbol">${stock.symbol}</div>
        </div>
      </div>
      <div class="card-error">âš ï¸ ${message}</div>
      <a class="card-link" href="${stock.link}" target="_blank">Details auf Finanzen.net â†’</a>
    `;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HAUPT-LADEFUNKTION
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function updateAll() {
    const btn = document.getElementById("refresh-btn");
    btn.disabled = true;
    btn.textContent = "â³ LÃ¤dtâ€¦";

    document.getElementById("status-banner").textContent = "Daten werden aktualisiertâ€¦";

    /* Skeleton anzeigen */
    STOCKS.forEach(s => skeletonCard(s.name, s.symbol));

    /* Wechselkurse zuerst */
    await loadFxRates();

    /* Alle Aktien parallel laden */
    await Promise.all(STOCKS.map(async stock => {
      try {
        const data    = await fetchChartData(stock.symbol);
        const raw     = data.indicators.quote[0].close.filter(p => p != null);
        const ts      = data.timestamp;
        const rate    = fxRates[stock.currency] ?? 1;

        const pricesEUR = raw.map(p => p * rate);
        const labels    = ts.slice(0, raw.length).map(t =>
          new Date(t * 1000).toLocaleDateString("de-DE", { weekday: "short", day: "2-digit", month: "2-digit" })
        );

        const latest = (data.meta?.regularMarketPrice ?? raw.at(-1)) * rate;
        const prev   = pricesEUR.at(-2) ?? pricesEUR.at(-1);

        fillCard(stock, pricesEUR, labels, latest, prev);

      } catch (e) {
        console.error(stock.symbol, e);
        errorCard(stock, "Daten konnten nicht geladen werden.");
      }
    }));

    /* Status aktualisieren */
    const now = new Date().toLocaleTimeString("de-DE");
    document.getElementById("last-update").textContent = "Stand: " + now;
    document.getElementById("status-banner").textContent = "";

    btn.disabled = false;
    btn.textContent = "ğŸ”„ Aktualisieren";
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     START
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  document.getElementById("refresh-btn").addEventListener("click", updateAll);
  updateAll();
  setInterval(updateAll, 60000);
  </script>
</body>
</html>
