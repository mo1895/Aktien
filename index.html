<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Live MarktÃ¼bersicht</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .item { margin-bottom: 60px; }
    h2 { margin-bottom: 5px; }
    .change-up { color: green; }
    .change-down { color: red; }
    .change-neutral { color: gray; }
    #refresh-btn {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background-color: #0055aa;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      z-index: 999;
    }
  </style>
</head>
<body>
  <button id="refresh-btn">ðŸ”„ Aktualisieren</button>
  <h1>ðŸ“ˆ MarktÃ¼bersicht in Euro (Live)</h1>
  <div id="stocks"></div>
  <div id="gold" class="item"></div>

  <script>
    const stocks = [
      { name: "Clara Technologies", symbol: "CLTE.CA", currency: "CAD", link: "https://www.finanzen.net/aktien/clara_technologies-aktie" },
      { name: "Lufthansa", symbol: "LHA.DE", currency: "EUR", link: "https://www.finanzen.net/aktien/lufthansa-aktie" },
      { name: "DroneShield", symbol: "DRO.AX", currency: "AUD", link: "https://www.finanzen.net/aktien/droneshield-aktie" },
      { name: "BYD", symbol: "1211.HK", currency: "HKD", link: "https://www.finanzen.net/aktien/byd-aktie" },
      { name: "Intel", symbol: "INTC", currency: "USD", link: "https://www.finanzen.net/aktien/intel-aktie" },
      { name: "Siemens Energy", symbol: "ENR.DE", currency: "EUR", link: "https://www.finanzen.net/aktien/siemens_energy-aktie" }
    ];

    const fxRates = {};
    const charts = {};

    async function fetchExchangeRate(from) {
      if (from === "EUR") return 1;
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${from}EUR=X?range=1d&interval=1d`;
      const resp = await fetch(url);
      const data = await resp.json();
      return data.chart.result[0].meta.regularMarketPrice;
    }

    async function fetchStockData(symbol) {
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=5d&interval=1d`;
      const resp = await fetch(url);
      return (await resp.json()).chart.result[0];
    }

    function getChangeClass(change) {
      if (change > 0) return "change-up";
      if (change < 0) return "change-down";
      return "change-neutral";
    }

    function createOrUpdateChart(canvasId, labels, prices, label) {
      if (charts[canvasId]) {
        charts[canvasId].data.labels = labels;
        charts[canvasId].data.datasets[0].data = prices;
        charts[canvasId].update();
      } else {
        const ctx = document.getElementById(canvasId).getContext('2d');
        charts[canvasId] = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label,
              data: prices,
              borderColor: 'blue',
              backgroundColor: 'lightblue',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } }
          }
        });
      }
    }

    async function loadStocks() {
      const container = document.getElementById("stocks");
      if (!container.dataset.initialized) {
        container.innerHTML = ""; // Nur beim ersten Laden leeren
        container.dataset.initialized = "true";
      }

      const currencies = [...new Set(stocks.map(s => s.currency))];
      for (const cur of currencies) {
        fxRates[cur] = await fetchExchangeRate(cur);
      }

      for (const s of stocks) {
        try {
          const d = await fetchStockData(s.symbol);
          const ts = d.timestamp;
          const raw = d.indicators.quote[0].close;
          const rate = fxRates[s.currency];
          const prices = raw.map(p => p * rate);
          const dates = ts.map(t => new Date(t * 1000).toLocaleDateString());
          const last = prices.at(-1);
          const prev = prices.at(-2);
          const change = last - prev;
          const pct = (change / prev) * 100;
          const cls = getChangeClass(change);
          const id = `c-${s.symbol}`;

          let div = document.getElementById(`item-${s.symbol}`);
          if (!div) {
            div = document.createElement("div");
            div.className = "item";
            div.id = `item-${s.symbol}`;
            div.innerHTML = `
              <h2>${s.name} (${s.symbol})</h2>
              <p id="price-${s.symbol}"></p>
              <p><a href="${s.link}" target="_blank">ðŸ“Š Mehr bei Finanzen.net</a></p>
              <canvas id="${id}" height="150"></canvas>
            `;
            container.appendChild(div);
          }
          document.getElementById(`price-${s.symbol}`).innerHTML = `
            Kurs in â‚¬: <strong>${last.toFixed(2)} â‚¬</strong>
            <span class="${cls}">(${change >= 0 ? '+' : ''}${change.toFixed(2)}â€¯â‚¬ / ${pct.toFixed(2)}%)</span>
          `;
          createOrUpdateChart(id, dates, prices, s.name + ' (â‚¬)');
        } catch (e) {
          console.error("Fehler bei", s.symbol, e);
        }
      }
    }

    async function loadGold() {
      const goldDiv = document.getElementById("gold");
      const rhein = 975.93; // Rheinische ScheidestÃ¤tte 10g Gold

      const resp = await fetch('https://query1.finance.yahoo.com/v7/finance/quote?symbols=GC=F');
      const d = (await resp.json()).quoteResponse.result[0];
      const usd = d.regularMarketPrice;
      const prevUsd = d.regularMarketPreviousClose;
      const pct = ((usd - prevUsd) / prevUsd) * 100;
      const fx = await fetchExchangeRate("USD");
      const perOz = usd * fx;
      const per10g = perOz / 31.1034768 * 10;
      const cls = getChangeClass(per10g - prevUsd * fx / 31.1034768 * 10);

      goldDiv.innerHTML = `
        <h2>Gold (10â€¯g)</h2>
        <p>Rheinische ScheidestÃ¤tteâ€‘Preis: <strong>${rhein.toFixed(2)} â‚¬</strong></p>
        <p>Marktpreis (Finanzen.net): <strong>${per10g.toFixed(2)} â‚¬</strong>
          <span class="${cls}">(${pct.toFixed(2)}%)</span></p>
        <p><a href="https://www.finanzen.net/rohstoffe/goldpreis/realtimekurse" target="_blank">ðŸª™ Goldpreis auf Finanzen.net</a></p>
      `;
    }

    function updateAll() {
      loadStocks();
      loadGold();
    }

    // Initial laden & automatisch alle 60 Sekunden aktualisieren
    updateAll();
    setInterval(updateAll, 60000);

    // Manuell per Button
    document.getElementById("refresh-btn").addEventListener("click", updateAll);
  </script>
</body>
</html>
